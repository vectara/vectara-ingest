name: Create and publish Docker images

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      version:
        description: 'Version tag (e.g., 2.0.8)'
        required: true
        default: 'latest'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  DOCKERHUB_IMAGE_NAME: vectara/vectara-ingest

jobs:
  build-and-push-image:
    runs-on: ubuntu-latest-8-cores  # Using larger runner with more disk space
    permissions:
      contents: read
      packages: write
      attestations: write
      id-token: write

    steps:
      - name: Free up disk space
        run: |
          # Remove unnecessary files to free up disk space
          sudo rm -rf /usr/share/dotnet
          sudo rm -rf /usr/local/lib/android
          sudo rm -rf /opt/ghc
          sudo rm -rf /opt/hostedtoolcache/CodeQL
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf /usr/local/graalvm/
          sudo rm -rf /usr/local/.ghcup/
          sudo rm -rf /usr/share/swift
          
          # Clean up Docker to free space (with proper error handling)
          if command -v docker >/dev/null 2>&1; then
            echo "Docker is available, cleaning up..."
            if docker system prune --all --force --volumes; then
              echo "Docker cleanup completed successfully"
            else
              echo "Warning: Docker cleanup failed, but continuing..."
            fi
          else
            echo "Docker is not available, skipping Docker cleanup"
          fi
          
          # Show available disk space
          df -h

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        with:
          driver-opts: network=host

      # Login to Docker Hub
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # Login to GitHub Container Registry
      - name: Log in to the Container registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "release" ]; then
            VERSION=${GITHUB_REF#refs/tags/}
          else
            VERSION=${{ github.event.inputs.version }}
          fi
          echo "version=${VERSION}" >> $GITHUB_OUTPUT

      # Build and push regular version
      - name: Build and push regular Docker image
        id: push_regular
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: true
          build-args: |
            INSTALL_EXTRA=false
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.version }}
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
            ${{ env.DOCKERHUB_IMAGE_NAME }}:${{ steps.version.outputs.version }}
            ${{ env.DOCKERHUB_IMAGE_NAME }}:latest
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Clean up Docker images after regular build
        run: |
          # Clean up intermediate images and build cache to free space
          if command -v docker >/dev/null 2>&1; then
            echo "Cleaning up Docker images after regular build..."
            if docker system prune --force; then
              echo "Docker cleanup after regular build completed successfully"
            else
              echo "Error: Docker cleanup after regular build failed"
              exit 1
            fi
          else
            echo "Error: Docker is not available for cleanup"
            exit 1
          fi
          df -h

      # Build and push full version
      - name: Build and push full Docker image
        id: push_full
        uses: docker/build-push-action@v5
        with:
          context: .
          platforms: linux/amd64,linux/arm64
          push: true
          build-args: |
            INSTALL_EXTRA=true
          tags: |
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ steps.version.outputs.version }}.full
            ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest.full
            ${{ env.DOCKERHUB_IMAGE_NAME }}:${{ steps.version.outputs.version }}.full
            ${{ env.DOCKERHUB_IMAGE_NAME }}:latest.full
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Clean up Docker images after full build
        run: |
          # Final cleanup
          if command -v docker >/dev/null 2>&1; then
            echo "Performing final Docker cleanup..."
            if docker system prune --all --force --volumes; then
              echo "Final Docker cleanup completed successfully"
            else
              echo "Error: Final Docker cleanup failed"
              exit 1
            fi
          else
            echo "Error: Docker is not available for final cleanup"
            exit 1
          fi
          df -h

      # Generate attestation for regular image
      - name: Generate artifact attestation for regular image
        uses: actions/attest-build-provenance@v2
        with:
          subject-name: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME}}
          subject-digest: ${{ steps.push_regular.outputs.digest }}
          push-to-registry: true

      # Generate attestation for full image
      - name: Generate artifact attestation for full image
        uses: actions/attest-build-provenance@v2
        with:
          subject-name: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME}}
          subject-digest: ${{ steps.push_full.outputs.digest }}
          push-to-registry: true 