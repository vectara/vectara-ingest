import logging
from core.crawler import Crawler
from omegaconf import OmegaConf
import requests

class HubspotCRMCrawler(Crawler):

    def __init__(self, cfg: OmegaConf, endpoint: str, customer_id: str, corpus_id: int, api_key: str) -> None:
        super().__init__(cfg, endpoint, customer_id, corpus_id, api_key)
        self.base_url = "https://api.hubapi.com/crm/v3/objects/"
        self.access_token = self.cfg.hubspot_crawler.access_token

    def crawl(self):
        headers = {
            "Authorization": f"Bearer {self.access_token}",
            "Content-Type": "application/json"
        }

        # Define the API endpoint and parameters
        api_endpoint = self.base_url + "contacts/search"
        params = {
            "limit": 100,  # Set the number of records to retrieve per request
            "properties": ["email", "firstname", "lastname"]  # Specify the properties to retrieve
            # Add any other parameters based on your specific requirements
        }

        # Crawl the CRM API
        results = []
        has_more = True
        while has_more:
            response = requests.get(api_endpoint, headers=headers, params=params)
            if response.status_code == 200:
                data = response.json()
                results.extend(data["results"])
                has_more = data["paging"].get("next", False)
                if has_more:
                    params["after"] = data["paging"]["next"]["after"]
            else:
                logging.error(f"Error: {response.status_code} - {response.text}")
                break

        # Process the crawled data
        for contact in results:
            email = contact["properties"]["email"]
            first_name = contact["properties"]["firstname"]
            last_name = contact["properties"]["lastname"]
            # Perform any desired processing or storage of the data here
            logging.info(f"Email: {email}, First Name: {first_name}, Last Name: {last_name}")

        # Additional processing or analysis can be performed based on your requirements
